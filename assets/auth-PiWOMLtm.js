import{am as j,f as h,j as m}from"./vendor-vue-BvKyvIVR.js";import{a as x}from"./vendor-utils-Cfk84l6i.js";import{tokenStorage as i}from"./token-storage.service-BqAv9k07.js";var S=(s=>(s.MASTER="master",s.ORGANIZATION_ADMIN="organization_admin",s.ORGANIZATION_USER="organization_user",s.DEMO_USER="demo_user",s))(S||{});function B(s){s.interceptors.request.use(t=>{if(!(t.url?.includes("/auth/login")||t.url?.includes("/auth/refresh"))){const o=i.getAccessToken();o&&!i.isTokenExpired()&&(t.headers.Authorization=`Bearer ${o}`)}return t},t=>Promise.reject(t)),s.interceptors.response.use(t=>t,async t=>{const r=t.config;if(t.response?.status===401&&!r._retry){if(r._retry=!0,r.url?.includes("/auth/login")||r.url?.includes("/auth/refresh"))return Promise.reject(t);const l=i.getRefreshToken();if(l)try{const p=(await s.post("/auth/refresh",{refreshToken:l})).data.accessToken;return i.setAccessToken(p),r.headers.Authorization=`Bearer ${p}`,s(r)}catch(u){return console.warn("Token refresh failed:",u),i.clearTokens(),typeof window<"u"&&window.location.pathname!=="/login"&&(window.location.href="/login"),Promise.reject(u)}else i.clearTokens(),typeof window<"u"&&window.location.pathname!=="/login"&&(window.location.href="/login")}return Promise.reject(t)})}const R="http://localhost:3001/api";class ${client;constructor(){this.client=x.create({baseURL:R,timeout:3e4,headers:{"Content-Type":"application/json",Accept:"application/json"}}),B(this.client)}async get(t,r){return(await this.client.get(t,{params:r})).data}async post(t,r){return(await this.client.post(t,r)).data}async put(t,r){return(await this.client.put(t,r)).data}async patch(t,r){return(await this.client.patch(t,r)).data}async delete(t){return(await this.client.delete(t)).data}getBaseURL(){return R}}const k=new $;class q{baseURL="/auth";async login(t){return await k.post(`${this.baseURL}/login`,t)}async refreshToken(t){const r={refreshToken:t};return await k.post(`${this.baseURL}/refresh`,r)}async logout(){await k.post(`${this.baseURL}/logout`)}async getMe(){return await k.get(`${this.baseURL}/me`)}async validateToken(){try{return await this.getMe(),!0}catch{return!1}}}const v=new q,F=j("auth",()=>{const s=h(null),t=h(null),r=h(null),o=h(!1),l=h(null),u=m(()=>!!t.value&&!!s.value),p=m(()=>s.value?.role),U=m(()=>s.value?.organizationId),M=m(()=>s.value?.fullName||s.value?.username),_=async e=>{o.value=!0,l.value=null;try{const n=await v.login(e);N(n)}catch(n){const a=n instanceof Error?n.message:"Login failed";throw l.value=a,n}finally{o.value=!1}},z=async()=>{o.value=!0,l.value=null;try{r.value&&await v.logout()}catch(e){const n=e instanceof Error?e.message:"Logout failed";console.warn("Logout API failed:",n)}finally{f(),o.value=!1}},w=async()=>{if(!r.value)return!1;try{const e=await v.refreshToken(r.value);return t.value=e.accessToken,i.setAccessToken(e.accessToken),!0}catch(e){const n=e instanceof Error?e.message:"Token refresh failed";return console.error("Token refresh failed:",n),f(),!1}},L=async e=>{if(s.value){o.value=!0,l.value=null;try{s.value={...s.value,...e},i.setTokens(t.value||"",r.value||"",s.value)}catch(n){const a=n instanceof Error?n.message:"Profile update failed";throw l.value=a,n}finally{o.value=!1}}},y=()=>{const e=i.getAccessToken(),n=i.getRefreshToken(),a=i.getUser();return e&&n&&a?(t.value=e,r.value=n,s.value=a,T(t.value),!0):!1},N=e=>{const{accessToken:n,refreshToken:a,user:c}=e;t.value=n,r.value=a,s.value=c,i.setTokens(n,a,c),T(n)},f=()=>{t.value=null,r.value=null,s.value=null,i.clearTokens(),A()};let d=null,g=null;function O(e){if(!e)return null;try{const n=e.split(".");if(n.length!==3)return null;const a=JSON.parse(atob(n[1]));return!a||!a.exp?null:a.exp*1e3}catch{return null}}function A(){d&&(clearTimeout(d),d=null),g&&(clearTimeout(g),g=null)}function T(e){A();const n=O(e);if(!n)return;const a=Date.now(),c=n-a;if(c<=0){f(),typeof window<"u"&&(window.location.href="/login");return}d=setTimeout(()=>{f(),typeof window<"u"&&(window.location.href="/login")},c+1e3);const P=60*1e3,E=c-P;E>0&&r.value&&(g=setTimeout(async()=>{await w()&&T(t.value)},E))}const b=async()=>{try{const e=await v.getMe();s.value=e,i.setTokens(t.value||"",r.value||"",e)}catch(e){const n=e instanceof Error?e.message:"Failed to fetch user info";console.error("Fetch user info failed:",n),f()}},I=e=>{const n={id:e.id||"1",email:e.email||"",fullName:e.fullName||"Mock User",username:e.username||"mockuser",role:e.role||S.DEMO_USER,organizationId:e.organizationId||"org-1",organizationName:e.organizationName||"Mock Organization",language:e.language||"pt-BR",timezone:e.timezone||"America/Sao_Paulo",lastLoginAt:e.lastLoginAt||new Date().toISOString(),isActive:!0,preferences:e.preferences};s.value=n,t.value="mock-token",r.value="mock-refresh-token",i.setTokens("mock-token","mock-refresh-token",n)};return y(),{user:s,accessToken:t,refreshToken:r,isLoading:o,error:l,isAuthenticated:u,userRole:p,userName:M,currentOrganization:U,login:_,logout:z,refreshAuth:w,updateUserProfile:L,checkAuthStatus:y,fetchUserInfo:b,setUser:I}}),H=Object.freeze(Object.defineProperty({__proto__:null,useAuthStore:F},Symbol.toStringTag,{value:"Module"}));export{$ as A,S as U,k as a,H as b,F as u};
