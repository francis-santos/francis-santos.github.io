import{f as g,am as $,j as O}from"./vendor-vue-BOgiBTV5.js";import{a as J}from"./vendor-utils-C9OYYH06.js";import{tokenStorage as c}from"./token-storage.service-BqAv9k07.js";var B=(n=>(n.MASTER="master",n.ORGANIZATION_ADMIN="organization_admin",n.ORGANIZATION_USER="organization_user",n.DEMO_USER="demo_user",n))(B||{});function D(n){n.interceptors.request.use(e=>{if(!(e.url?.includes("/auth/login")||e.url?.includes("/auth/refresh"))){const a=c.getAccessToken();a&&!c.isTokenExpired()&&(e.headers.Authorization=`Bearer ${a}`)}return e},e=>Promise.reject(e)),n.interceptors.response.use(e=>e,async e=>{const o=e.config;if(e.response?.status===401&&!o._retry){if(o._retry=!0,o.url?.includes("/auth/login")||o.url?.includes("/auth/refresh"))return Promise.reject(e);const l=c.getRefreshToken();if(l)try{const m=(await n.post("/auth/refresh",{refreshToken:l})).data.accessToken;return c.setAccessToken(m),o.headers.Authorization=`Bearer ${m}`,n(o)}catch(u){return console.warn("Token refresh failed:",u),c.clearTokens(),typeof window<"u"&&window.location.pathname!=="/login"&&(window.location.href="/login"),Promise.reject(u)}else c.clearTokens(),typeof window<"u"&&window.location.pathname!=="/login"&&(window.location.href="/login")}return Promise.reject(e)})}const C="http://localhost:3001/api";class W{client;constructor(){this.client=J.create({baseURL:C,timeout:3e4,headers:{"Content-Type":"application/json",Accept:"application/json"}}),D(this.client)}async get(e,o){return(await this.client.get(e,{params:o})).data}async post(e,o){return(await this.client.post(e,o)).data}async put(e,o){return(await this.client.put(e,o)).data}async patch(e,o){return(await this.client.patch(e,o)).data}async delete(e){return(await this.client.delete(e)).data}getBaseURL(){return C}}const U=new W;class q{baseURL="/auth";async login(e){return await U.post(`${this.baseURL}/login`,e)}async refreshToken(e){const o={refreshToken:e};return await U.post(`${this.baseURL}/refresh`,o)}async logout(){await U.post(`${this.baseURL}/logout`)}async getMe(){return await U.get(`${this.baseURL}/me`)}async validateToken(){try{return await this.getMe(),!0}catch{return!1}}}const M=new q;function j(n){if(n==null)return n;if(Array.isArray(n))return n.map(e=>j(e));if(typeof n=="object"){const e={};for(const[o,a]of Object.entries(n))if(!(typeof a=="function"||typeof a=="symbol"||a===void 0)){if(a instanceof Date){e[o]=a.toISOString();continue}if(typeof a=="object"&&a!==null){try{e[o]=j(a)}catch(l){console.warn(`Failed to sanitize property ${o}:`,l)}continue}e[o]=a}return e}return n}function G(){const n=`tab-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,e=g(!1),o=g([]);let a=null;const l=new Map,u=()=>{typeof BroadcastChannel<"u"?(e.value=!0,m()):(e.value=!0,S()),A(),p("tab:register",N),p("tab:unregister",I),w("tab:register",{tabId:n})},m=()=>{try{a=new BroadcastChannel("mira-cross-tab"),a.addEventListener("message",s=>{E(s.data)})}catch(s){console.warn("Failed to initialize BroadcastChannel:",s),S()}},S=()=>{window.addEventListener("storage",s=>{if(s.key==="mira-cross-tab-event"&&s.newValue)try{const t=JSON.parse(s.newValue);E(t)}catch(t){console.warn("Failed to parse cross-tab event:",t)}})},A=()=>{const s=y();s.includes(n)||(s.push(n),localStorage.setItem("mira-registered-tabs",JSON.stringify(s)),o.value=s.filter(t=>t!==n))},k=()=>{const t=y().filter(r=>r!==n);localStorage.setItem("mira-registered-tabs",JSON.stringify(t)),w("tab:unregister",{tabId:n})},y=()=>{try{const s=localStorage.getItem("mira-registered-tabs");return s?JSON.parse(s):[]}catch{return[]}},N=s=>{if(s.tabId&&s.tabId!==n){const t=o.value;t.includes(s.tabId)||(t.push(s.tabId),o.value=[...t])}},I=s=>{s.tabId&&s.tabId!==n&&(o.value=o.value.filter(t=>t!==s.tabId))},E=s=>{if(s.tabId===n)return;const t=l.get(s.type);t&&t.forEach(r=>{try{r(s.data,s)}catch(i){console.error(`Error handling sync event ${s.type}:`,i)}})},w=(s,t)=>{if(!e.value)return;const r=t?j(t):void 0,i={type:s,data:r,timestamp:Date.now(),tabId:n};try{a?a.postMessage(i):(localStorage.setItem("mira-cross-tab-event",JSON.stringify(i)),setTimeout(()=>{localStorage.getItem("mira-cross-tab-event")===JSON.stringify(i)&&localStorage.removeItem("mira-cross-tab-event")},100))}catch(d){console.error("Failed to emit cross-tab event:",d),console.error("Event type:",s),console.error("Original data:",t),console.error("Sanitized data:",r)}},p=(s,t)=>(l.has(s)||l.set(s,new Set),l.get(s).add(t),()=>{const r=l.get(s);r&&(r.delete(t),r.size===0&&l.delete(s))}),P=s=>{l.delete(s)},f=()=>{l.clear(),a&&(a.close(),a=null),k()},v=()=>o.value.length>0,T=()=>o.value.length+1,L=()=>{k()};let h=null;const b=()=>{h=window.setInterval(()=>{const s=y(),t=[n];s.length!==t.length&&(localStorage.setItem("mira-registered-tabs",JSON.stringify(t)),o.value=t.filter(r=>r!==n))},3e4)},_=()=>{h&&(clearInterval(h),h=null)},R=()=>{u(),window.addEventListener("beforeunload",L),b()},z=()=>{f(),window.removeEventListener("beforeunload",L),_()};return typeof window<"u"&&setTimeout(()=>{try{R()}catch(s){console.warn("TabSync auto-initialization failed:",s)}},0),{isSupported:e,connectedTabs:o,tabId:n,emit:w,on:p,off:P,destroy:f,hasOtherTabs:v,getTabCount:T,registerTab:A,unregisterTab:k,initialize:R,cleanup:z}}function V(){const n=G();return{...n,emitLogin:(e,o)=>n.emit("auth:login",{user:e,tokens:o}),emitLogout:e=>n.emit("auth:logout",{reason:e}),emitTokenRefresh:e=>n.emit("auth:token-refresh",{tokens:e}),emitProfileUpdate:e=>n.emit("auth:profile-update",{user:e}),emitSessionExpired:e=>n.emit("auth:session-expired",{reason:e}),emitIdleWarningStart:e=>n.emit("idle:warning-start",{timeRemaining:e}),emitIdleWarningDismiss:e=>n.emit("idle:warning-dismiss",{extended:e}),emitActivityDetected:e=>n.emit("idle:activity-detected",{timestamp:e}),emitIdleForceLogout:e=>n.emit("idle:force-logout",{reason:e}),onLogin:e=>n.on("auth:login",e),onLogout:e=>n.on("auth:logout",e),onTokenRefresh:e=>n.on("auth:token-refresh",e),onProfileUpdate:e=>n.on("auth:profile-update",e),onSessionExpired:e=>n.on("auth:session-expired",e),onIdleWarningStart:e=>n.on("idle:warning-start",e),onIdleWarningDismiss:e=>n.on("idle:warning-dismiss",e),onActivityDetected:e=>n.on("idle:activity-detected",e),onIdleForceLogout:e=>n.on("idle:force-logout",e)}}const Z=$("auth",()=>{const n=V(),e=g(null),o=g(null),a=g(null),l=g(!1),u=g(null),m=O(()=>!!o.value&&!!e.value),S=O(()=>e.value?.role),A=O(()=>e.value?.organizationId),k=O(()=>e.value?.fullName||e.value?.username),y=async t=>{l.value=!0,u.value=null;try{const r=await M.login(t);P(r),n.emitLogin(e.value,{accessToken:o.value,refreshToken:a.value})}catch(r){const i=r instanceof Error?r.message:"Login failed";throw u.value=i,r}finally{l.value=!1}},N=async t=>{l.value=!0,u.value=null;try{a.value&&await M.logout(),n.emitLogout(t)}catch(r){const i=r instanceof Error?r.message:"Logout failed";console.warn("Logout API failed:",i)}finally{f(),l.value=!1}},I=async()=>{if(!a.value)return!1;try{const t=await M.refreshToken(a.value);return o.value=t.accessToken,c.setAccessToken(t.accessToken),n.emitTokenRefresh({accessToken:t.accessToken,refreshToken:a.value}),!0}catch(t){const r=t instanceof Error?t.message:"Token refresh failed";return console.error("Token refresh failed:",r),n.emitSessionExpired("Token refresh failed"),f(),!1}},E=async t=>{if(e.value){l.value=!0,u.value=null;try{await new Promise(r=>setTimeout(r,500)),e.value={...e.value,...t},c.setTokens(o.value||"",a.value||"",e.value),n.emitProfileUpdate(e.value)}catch(r){const i=r instanceof Error?r.message:"Profile update failed";throw u.value=i,r}finally{l.value=!1}}},w=async t=>{if(e.value){l.value=!0,u.value=null;try{e.value={...e.value,...updates},c.setTokens(o.value||"",a.value||"",e.value)}catch(r){const i=r instanceof Error?r.message:"Profile update failed";throw u.value=i,r}finally{l.value=!1}}},p=()=>{const t=c.getAccessToken(),r=c.getRefreshToken(),i=c.getUser();return t&&r&&i?(o.value=t,a.value=r,e.value=i,b(o.value),!0):!1},P=t=>{const{accessToken:r,refreshToken:i,user:d}=t;o.value=r,a.value=i,e.value=d,c.setTokens(r,i,d),b(r)},f=()=>{o.value=null,a.value=null,e.value=null,c.clearTokens(),h()};let v=null,T=null;function L(t){if(!t)return null;try{const r=t.split(".");if(r.length!==3)return null;const i=JSON.parse(atob(r[1]));return!i||!i.exp?null:i.exp*1e3}catch{return null}}function h(){v&&(clearTimeout(v),v=null),T&&(clearTimeout(T),T=null)}function b(t){h();const r=L(t);if(!r)return;const i=Date.now(),d=r-i;if(d<=0){f(),typeof window<"u"&&(window.location.href="/login");return}v=setTimeout(()=>{f(),typeof window<"u"&&(window.location.href="/login")},d+1e3);const F=60*1e3,x=d-F;x>0&&a.value&&(T=setTimeout(async()=>{await I()&&b(o.value)},x))}const _=async()=>{try{const t=await M.getMe();e.value=t,c.setTokens(o.value||"",a.value||"",t)}catch(t){const r=t instanceof Error?t.message:"Failed to fetch user info";console.error("Fetch user info failed:",r),f()}},R=t=>{const r={id:t.id||"1",email:t.email||"",fullName:t.fullName||"Mock User",username:t.username||"mockuser",role:t.role||B.DEMO_USER,organizationId:t.organizationId||"org-1",organizationName:t.organizationName||"Mock Organization",language:t.language||"pt-BR",timezone:t.timezone||"America/Sao_Paulo",lastLoginAt:t.lastLoginAt||new Date().toISOString(),isActive:!0,preferences:t.preferences};e.value=r,o.value="mock-token",a.value="mock-refresh-token",c.setTokens("mock-token","mock-refresh-token",r)},z=t=>{f(),u.value=`SessÃ£o encerrada: ${t}`};return(()=>{n.onLogin(t=>{t.user&&t.tokens&&(e.value=t.user,o.value=t.tokens.accessToken,a.value=t.tokens.refreshToken,u.value=null)}),n.onLogout(t=>{z(t.reason||"Logout realizado em outra aba")}),n.onTokenRefresh(t=>{t.tokens&&(o.value=t.tokens.accessToken,a.value=t.tokens.refreshToken,c.setAccessToken(t.tokens.accessToken))}),n.onProfileUpdate(t=>{t.user&&(e.value=t.user,c.setTokens(o.value||"",a.value||"",t.user))}),n.onSessionExpired(t=>{z(t.reason)})})(),p(),{user:e,accessToken:o,refreshToken:a,isLoading:l,error:u,isAuthenticated:m,userRole:S,userName:k,currentOrganization:A,login:y,logout:N,refreshAuth:I,updateProfile:E,updateUserProfile:w,checkAuthStatus:p,fetchUserInfo:_,setUser:R}}),Y=Object.freeze(Object.defineProperty({__proto__:null,useAuthStore:Z},Symbol.toStringTag,{value:"Module"}));export{W as A,B as U,V as a,U as b,Y as c,Z as u};
