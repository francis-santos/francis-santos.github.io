import{d as v,an as J,h as z}from"./vendor-vue-BKuzT1x2.js";import{a as M}from"./auth.service-BozCwdnf.js";import{tokenStorage as u}from"./token-storage.service-BqAv9k07.js";var C=(n=>(n.MASTER="master",n.ORGANIZATION_ADMIN="organization_admin",n.ORGANIZATION_USER="organization_user",n.DEMO_USER="demo_user",n))(C||{});function P(n){if(n==null)return n;if(Array.isArray(n))return n.map(t=>P(t));if(typeof n=="object"){const t={};for(const[a,s]of Object.entries(n))if(!(typeof s=="function"||typeof s=="symbol"||s===void 0)){if(s instanceof Date){t[a]=s.toISOString();continue}if(typeof s=="object"&&s!==null){try{t[a]=P(s)}catch(l){console.warn(`Failed to sanitize property ${a}:`,l)}continue}t[a]=s}return t}return n}function B(){const n=`tab-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t=v(!1),a=v([]);let s=null;const l=new Map,c=()=>{typeof BroadcastChannel<"u"?(t.value=!0,N()):(t.value=!0,S()),w(),m("tab:register",U),m("tab:unregister",I),b("tab:register",{tabId:n})},N=()=>{try{s=new BroadcastChannel("mira-cross-tab"),s.addEventListener("message",r=>{A(r.data)})}catch(r){console.warn("Failed to initialize BroadcastChannel:",r),S()}},S=()=>{window.addEventListener("storage",r=>{if(r.key==="mira-cross-tab-event"&&r.newValue)try{const e=JSON.parse(r.newValue);A(e)}catch(e){console.warn("Failed to parse cross-tab event:",e)}})},w=()=>{const r=p();r.includes(n)||(r.push(n),localStorage.setItem("mira-registered-tabs",JSON.stringify(r)),a.value=r.filter(e=>e!==n))},k=()=>{const e=p().filter(o=>o!==n);localStorage.setItem("mira-registered-tabs",JSON.stringify(e)),b("tab:unregister",{tabId:n})},p=()=>{try{const r=localStorage.getItem("mira-registered-tabs");return r?JSON.parse(r):[]}catch{return[]}},U=r=>{if(r.tabId&&r.tabId!==n){const e=a.value;e.includes(r.tabId)||(e.push(r.tabId),a.value=[...e])}},I=r=>{r.tabId&&r.tabId!==n&&(a.value=a.value.filter(e=>e!==r.tabId))},A=r=>{if(r.tabId===n)return;const e=l.get(r.type);e&&e.forEach(o=>{try{o(r.data,r)}catch(i){console.error(`Error handling sync event ${r.type}:`,i)}})},b=(r,e)=>{if(!t.value)return;const o=e?P(e):void 0,i={type:r,data:o,timestamp:Date.now(),tabId:n};try{s?s.postMessage(i):(localStorage.setItem("mira-cross-tab-event",JSON.stringify(i)),setTimeout(()=>{localStorage.getItem("mira-cross-tab-event")===JSON.stringify(i)&&localStorage.removeItem("mira-cross-tab-event")},100))}catch(d){console.error("Failed to emit cross-tab event:",d),console.error("Event type:",r),console.error("Original data:",e),console.error("Sanitized data:",o)}},m=(r,e)=>(l.has(r)||l.set(r,new Set),l.get(r).add(e),()=>{const o=l.get(r);o&&(o.delete(e),o.size===0&&l.delete(r))}),R=r=>{l.delete(r)},f=()=>{l.clear(),s&&(s.close(),s=null),k()},h=()=>a.value.length>0,T=()=>a.value.length+1,E=()=>{k()};let g=null;const y=()=>{g=window.setInterval(()=>{const r=p(),e=[n];r.length!==e.length&&(localStorage.setItem("mira-registered-tabs",JSON.stringify(e)),a.value=e.filter(o=>o!==n))},3e4)},x=()=>{g&&(clearInterval(g),g=null)},L=()=>{c(),window.addEventListener("beforeunload",E),y()},O=()=>{f(),window.removeEventListener("beforeunload",E),x()};return typeof window<"u"&&setTimeout(()=>{try{L()}catch(r){console.warn("TabSync auto-initialization failed:",r)}},0),{isSupported:t,connectedTabs:a,tabId:n,emit:b,on:m,off:R,destroy:f,hasOtherTabs:h,getTabCount:T,registerTab:w,unregisterTab:k,initialize:L,cleanup:O}}function D(){const n=B();return{...n,emitLogin:(t,a)=>n.emit("auth:login",{user:t,tokens:a}),emitLogout:t=>n.emit("auth:logout",{reason:t}),emitTokenRefresh:t=>n.emit("auth:token-refresh",{tokens:t}),emitProfileUpdate:t=>n.emit("auth:profile-update",{user:t}),emitSessionExpired:t=>n.emit("auth:session-expired",{reason:t}),emitIdleWarningStart:t=>n.emit("idle:warning-start",{timeRemaining:t}),emitIdleWarningDismiss:t=>n.emit("idle:warning-dismiss",{extended:t}),emitActivityDetected:t=>n.emit("idle:activity-detected",{timestamp:t}),emitIdleForceLogout:t=>n.emit("idle:force-logout",{reason:t}),onLogin:t=>n.on("auth:login",t),onLogout:t=>n.on("auth:logout",t),onTokenRefresh:t=>n.on("auth:token-refresh",t),onProfileUpdate:t=>n.on("auth:profile-update",t),onSessionExpired:t=>n.on("auth:session-expired",t),onIdleWarningStart:t=>n.on("idle:warning-start",t),onIdleWarningDismiss:t=>n.on("idle:warning-dismiss",t),onActivityDetected:t=>n.on("idle:activity-detected",t),onIdleForceLogout:t=>n.on("idle:force-logout",t)}}const j=J("auth",()=>{const n=D(),t=v(null),a=v(null),s=v(null),l=v(!1),c=v(null),N=z(()=>!!a.value&&!!t.value),S=z(()=>t.value?.role),w=z(()=>t.value?.organizationId),k=z(()=>t.value?.fullName||t.value?.username),p=async e=>{l.value=!0,c.value=null;try{const o=await M.login(e);R(o),n.emitLogin(t.value,{accessToken:a.value,refreshToken:s.value})}catch(o){const i=o instanceof Error?o.message:"Login failed";throw c.value=i,o}finally{l.value=!1}},U=async e=>{l.value=!0,c.value=null;try{s.value&&await M.logout(),n.emitLogout(e)}catch(o){const i=o instanceof Error?o.message:"Logout failed";console.warn("Logout API failed:",i)}finally{f(),l.value=!1}},I=async()=>{if(!s.value)return!1;try{const e=await M.refreshToken(s.value);return a.value=e.accessToken,u.setAccessToken(e.accessToken),n.emitTokenRefresh({accessToken:e.accessToken,refreshToken:s.value}),!0}catch(e){const o=e instanceof Error?e.message:"Token refresh failed";return console.error("Token refresh failed:",o),n.emitSessionExpired("Token refresh failed"),f(),!1}},A=async e=>{if(t.value){l.value=!0,c.value=null;try{await new Promise(o=>setTimeout(o,500)),t.value={...t.value,...e},u.setTokens(a.value||"",s.value||"",t.value),n.emitProfileUpdate(t.value)}catch(o){const i=o instanceof Error?o.message:"Profile update failed";throw c.value=i,o}finally{l.value=!1}}},b=async e=>{if(t.value){l.value=!0,c.value=null;try{t.value={...t.value,...updates},u.setTokens(a.value||"",s.value||"",t.value)}catch(o){const i=o instanceof Error?o.message:"Profile update failed";throw c.value=i,o}finally{l.value=!1}}},m=()=>{const e=u.getAccessToken(),o=u.getRefreshToken(),i=u.getUser();return e&&o&&i?(a.value=e,s.value=o,t.value=i,y(a.value),!0):!1},R=e=>{const{accessToken:o,refreshToken:i,user:d}=e;a.value=o,s.value=i,t.value=d,u.setTokens(o,i,d),y(o)},f=()=>{a.value=null,s.value=null,t.value=null,u.clearTokens(),g()};let h=null,T=null;function E(e){if(!e)return null;try{const o=e.split(".");if(o.length!==3)return null;const i=JSON.parse(atob(o[1]));return!i||!i.exp?null:i.exp*1e3}catch{return null}}function g(){h&&(clearTimeout(h),h=null),T&&(clearTimeout(T),T=null)}function y(e){g();const o=E(e);if(!o)return;const i=Date.now(),d=o-i;if(d<=0){f(),typeof window<"u"&&(window.location.href="/login");return}h=setTimeout(()=>{f(),typeof window<"u"&&(window.location.href="/login")},d+1e3);const F=60*1e3,_=d-F;_>0&&s.value&&(T=setTimeout(async()=>{await I()&&y(a.value)},_))}const x=async()=>{try{const e=await M.getMe();t.value=e,u.setTokens(a.value||"",s.value||"",e)}catch(e){const o=e instanceof Error?e.message:"Failed to fetch user info";console.error("Fetch user info failed:",o),f()}},L=e=>{const o={id:e.id||"1",email:e.email||"",fullName:e.fullName||"Mock User",username:e.username||"mockuser",role:e.role||C.DEMO_USER,organizationId:e.organizationId||"org-1",organizationName:e.organizationName||"Mock Organization",language:e.language||"pt-BR",timezone:e.timezone||"America/Sao_Paulo",lastLoginAt:e.lastLoginAt||new Date().toISOString(),isActive:!0,preferences:e.preferences};t.value=o,a.value="mock-token",s.value="mock-refresh-token",u.setTokens("mock-token","mock-refresh-token",o)},O=e=>{f(),c.value=`SessÃ£o encerrada: ${e}`};return(()=>{n.onLogin(e=>{e.user&&e.tokens&&(t.value=e.user,a.value=e.tokens.accessToken,s.value=e.tokens.refreshToken,c.value=null)}),n.onLogout(e=>{O(e.reason||"Logout realizado em outra aba")}),n.onTokenRefresh(e=>{e.tokens&&(a.value=e.tokens.accessToken,s.value=e.tokens.refreshToken,u.setAccessToken(e.tokens.accessToken))}),n.onProfileUpdate(e=>{e.user&&(t.value=e.user,u.setTokens(a.value||"",s.value||"",e.user))}),n.onSessionExpired(e=>{O(e.reason)})})(),m(),{user:t,accessToken:a,refreshToken:s,isLoading:l,error:c,isAuthenticated:N,userRole:S,userName:k,currentOrganization:w,login:p,logout:U,refreshAuth:I,updateProfile:A,updateUserProfile:b,checkAuthStatus:m,fetchUserInfo:x,setUser:L}}),Z=Object.freeze(Object.defineProperty({__proto__:null,useAuthStore:j},Symbol.toStringTag,{value:"Module"}));export{C as U,D as a,Z as b,j as u};
